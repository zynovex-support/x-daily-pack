services:
  n8n:
    image: n8nio/n8n:1.123.17
    container_name: n8n-local
    restart: always
    ports:
      - "5678:5678"
    volumes:
      - ${HOME}/.n8n:/home/node/.n8n
    env_file:
      - .env
    environment:
      - TZ=UTC
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - CONFIG_SERVER_URL=http://config-server:3001
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false
      - EXECUTIONS_MODE=regular
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=internal
      - N8N_RUNNERS_TASK_TIMEOUT=300
      - N8N_RUNNERS_TASK_REQUEST_TIMEOUT=300
      - DB_SQLITE_POOL_SIZE=4
      - TELEGRAM_DAILY_BOT_TOKEN=${TELEGRAM_DAILY_BOT_TOKEN}
      - TELEGRAM_DAILY_CHAT_ID=${TELEGRAM_DAILY_CHAT_ID}
      - EXECUTIONS_TIMEOUT=600
      - EXECUTIONS_TIMEOUT_MAX=3600
      - NODE_FUNCTION_ALLOW_BUILTIN=*
      - NODE_FUNCTION_ALLOW_EXTERNAL=*
    depends_on:
      - config-server
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  config-server:
    image: node:18-alpine
    container_name: config-server
    restart: always
    working_dir: /app
    volumes:
      - ./scripts:/app/scripts:ro
      - ./config:/app/config
    command: node scripts/config-server.js
    ports:
      - "3001:3001"
    environment:
      - CONFIG_SERVER_PORT=3001
      - CONFIG_API_KEY=${CONFIG_API_KEY}
      - ALLOWED_ORIGINS=http://localhost:5678,http://n8n:5678
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
